import{c as lt,j as s,m as L,R as dt,r as p,x as Ne,E as Et,B as N,I as Pt,S as Oe,e as Me,b as J,s as ee,C as De,g as Re,H as X,J as kt,F as Mt,y as ut,u as Dt,a as Rt}from"./index-90132984.js";import{D as ft,a as pt,b as It,c as Lt,d as Ft,e as Ht,f as Gt}from"./dialog-0bf9ccb8.js";import{s as O}from"./customSupabaseClient-6a2b5399.js";import{S as qt}from"./scroll-area-3fa250e8.js";import{A as fe,h as pe,a as ge,b as me,c as he,d as ve,e as ye,f as _e,g as xe}from"./alert-dialog-e7e47e0b.js";import{T as zt}from"./textarea-a5266014.js";import{S as gt}from"./star-af4081c4.js";import{F as Bt}from"./file-text-53bcf6f7.js";import{C as Z}from"./check-circle-309764a3.js";import{X as Kt}from"./x-circle-c8e28e4a.js";import{P as Ut}from"./package-search-41bb550b.js";import{M as Yt}from"./MyShipmentsTabs-9e341ffe.js";import"./extends-4c19d496.js";import"./tabs-1cd19a03.js";import"./index-8d46d079.js";import"./card-20bc08aa.js";import"./package-63d15fb6.js";import"./arrow-right-cf1dab7a.js";import"./calendar-a9d8c619.js";import"./index-928e16c7.js";import"./index-ca7fca51.js";import"./user-404ce197.js";import"./credit-card-e15c187e.js";const Wt=lt("Paperclip",[["path",{d:"m21.44 11.05-9.19 9.19a6 6 0 0 1-8.49-8.49l8.57-8.57A4 4 0 1 1 18 8.84l-8.59 8.57a2 2 0 0 1-2.83-2.83l8.49-8.48",key:"1u3ebp"}]]),Vt=lt("Smile",[["circle",{cx:"12",cy:"12",r:"10",key:"1mglay"}],["path",{d:"M8 14s1.5 2 4 2 4-2 4-2",key:"1y1vjs"}],["line",{x1:"9",x2:"9.01",y1:"9",y2:"9",key:"yxxnd0"}],["line",{x1:"15",x2:"15.01",y1:"9",y2:"9",key:"1p4y9e"}]]),Jt=({otherUserName:e})=>s.jsx(L.div,{initial:{opacity:0,y:-10},animate:{opacity:1,y:0},className:"p-3 border-b border-slate-200 dark:border-slate-700 sticky top-0 bg-slate-50 dark:bg-slate-800 z-10",children:s.jsxs("h3",{className:"font-semibold text-lg text-foreground dark:text-slate-100",children:["Chat ",e?`with ${e}`:""]})}),mt=dt.memo(({message:e,isCurrentUser:t})=>{const r=t?"bg-primary text-primary-foreground self-end rounded-l-xl rounded-tr-xl":"bg-slate-200 dark:bg-slate-700 text-foreground dark:text-slate-100 self-start rounded-r-xl rounded-tl-xl",a=t?"text-right":"text-left";return s.jsxs(L.div,{layout:!0,initial:{opacity:0,y:10},animate:{opacity:1,y:0},exit:{opacity:0,y:-10},transition:{duration:.3},className:`max-w-[70%] p-3 my-1 shadow ${r}`,children:[s.jsx("p",{className:"text-sm whitespace-pre-wrap",children:e.content}),s.jsx("p",{className:`text-xs mt-1 opacity-70 ${a}`,children:new Date(e.created_at).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"})})]})});mt.displayName="MessageBubble";const Xt=({messages:e,currentUserId:t,isLoading:r})=>{const a=p.useRef(null),n=p.useRef(null),i=()=>{var o;(o=n.current)==null||o.scrollIntoView({behavior:"smooth"})};return p.useEffect(()=>{i()},[e]),r?s.jsx("div",{className:"flex-grow flex justify-center items-center p-4",children:s.jsx(Ne,{className:"h-8 w-8 animate-spin text-primary"})}):s.jsx(qt,{className:"flex-grow p-4",ref:a,children:s.jsxs("div",{className:"flex flex-col space-y-2",children:[s.jsx(Et,{children:e.map(o=>s.jsx(mt,{message:o,isCurrentUser:o.sender_user_id===t},o.id))}),s.jsx("div",{ref:n}),e.length===0&&!r&&s.jsxs("div",{className:"text-center text-muted-foreground dark:text-slate-400 py-10",children:[s.jsx(Vt,{className:"w-10 h-10 mx-auto mb-2 opacity-50"}),"No messages yet. Start the conversation!"]})]})})},Zt=({newMessage:e,setNewMessage:t,handleSendMessage:r,isSending:a})=>s.jsxs(L.form,{onSubmit:r,className:"p-3 border-t border-slate-200 dark:border-slate-700 flex items-center space-x-2 bg-white dark:bg-slate-800 sticky bottom-0",initial:{opacity:0,y:10},animate:{opacity:1,y:0},transition:{delay:.1},children:[s.jsx(N,{type:"button",variant:"ghost",size:"icon",className:"text-muted-foreground dark:text-slate-400 hover:text-primary",asChild:!0,children:s.jsx(L.div,{whileHover:{scale:1.1},whileTap:{scale:.9},children:s.jsx(Wt,{className:"w-5 h-5"})})}),s.jsx(Pt,{type:"text",placeholder:"Type a message...",value:e,onChange:n=>t(n.target.value),className:"flex-grow bg-slate-100 dark:bg-slate-700 border-transparent focus:border-primary focus:ring-primary",disabled:a}),s.jsx(N,{type:"submit",size:"icon",disabled:a||!e.trim(),asChild:!0,children:s.jsx(L.div,{whileHover:{scale:1.1},whileTap:{scale:.9},children:a?s.jsx(Ne,{className:"w-5 h-5 animate-spin"}):s.jsx(Oe,{className:"w-5 h-5"})})})]}),Qt=({rating:e,setRating:t,maxRating:r=5,size:a=24,className:n,starClassName:i})=>{const[o,c]=p.useState(0),d=h=>{c(h)},l=()=>{c(0)},u=h=>{t(h)};return s.jsx("div",{className:Me("flex items-center space-x-1",n),children:[...Array(r)].map((h,g)=>{const v=g+1;return s.jsx(gt,{size:a,className:Me("cursor-pointer transition-colors duration-150",(o||e)>=v?"text-yellow-400 fill-yellow-400":"text-slate-300 dark:text-slate-600",i),onMouseEnter:()=>d(v),onMouseLeave:l,onClick:()=>u(v)},v)})})},er=({isOpen:e,setIsOpen:t,shipment:r,currentUser:a,otherUser:n,reviewType:i,onReviewSubmitted:o})=>{const[c,d]=p.useState(0),[l,u]=p.useState(""),[h,g]=p.useState(!1),{toast:v}=J(),_=()=>{d(0),u(""),g(!1)},b=async()=>{if(c===0){v({title:"Rating Required",description:"Please select a star rating.",variant:"destructive"});return}if(!r||!a||!n){v({title:"Error",description:"Missing required information for review.",variant:"destructive"});return}g(!0);try{const{data:f,error:m}=await ee.from("reviews").insert({shipment_id:r.id,reviewer_user_id:a.id,reviewed_user_id:n.id,rating:c,comment:l,review_type:i});if(m)if(m.code==="23505")v({title:"Already Reviewed",description:"You have already submitted a review for this transaction.",variant:"default"});else throw m;else v({title:"Review Submitted!",description:`Your review for ${n.full_name||n.email} has been submitted.`,className:"bg-green-500 dark:bg-green-600 text-white"}),o&&o(f),_(),t(!1)}catch(f){console.error("Error submitting review:",f),v({title:"Error Submitting Review",description:f.message||"An unexpected error occurred.",variant:"destructive"})}finally{g(!1)}};return!r||!a||!n?null:s.jsx(ft,{open:e,onOpenChange:f=>{t(f),f||_()},children:s.jsxs(pt,{className:"sm:max-w-[480px] bg-gradient-to-br from-slate-50 via-white to-slate-100 dark:from-slate-800 dark:via-slate-900 dark:to-slate-850",children:[s.jsxs(It,{className:"text-center",children:[s.jsx("div",{className:"mx-auto mb-3 flex h-12 w-12 items-center justify-center rounded-full bg-gradient-to-br from-primary to-purple-600",children:s.jsx(gt,{className:"h-6 w-6 text-white"})}),s.jsx(Lt,{className:"text-2xl font-bold text-slate-800 dark:text-white",children:"Review Your Transaction"}),s.jsxs(Ft,{className:"text-slate-600 dark:text-slate-400",children:["Share your experience with ",n.full_name||n.email," for shipment ID: ",r.id.slice(0,8),"."]})]}),s.jsxs("div",{className:"py-6 space-y-6",children:[s.jsxs("div",{className:"flex flex-col items-center space-y-2",children:[s.jsx("p",{className:"text-sm font-medium text-slate-700 dark:text-slate-300",children:"Your Rating:"}),s.jsx(Qt,{rating:c,setRating:d,size:36})]}),s.jsxs("div",{children:[s.jsx("label",{htmlFor:"comment",className:"block text-sm font-medium text-slate-700 dark:text-slate-300 mb-1",children:"Your Comment (Optional):"}),s.jsx(zt,{id:"comment",placeholder:`How was your experience with ${n.full_name||n.email}?`,value:l,onChange:f=>u(f.target.value),className:"min-h-[100px] bg-white dark:bg-slate-700 border-slate-300 dark:border-slate-600 focus:ring-primary dark:focus:ring-purple-500",rows:4})]})]}),s.jsxs(Ht,{className:"gap-2 sm:gap-0",children:[s.jsx(Gt,{asChild:!0,children:s.jsx(N,{variant:"outline",className:"dark:text-slate-300 dark:border-slate-600 dark:hover:bg-slate-700",children:"Cancel"})}),s.jsxs(N,{onClick:b,disabled:h||c===0,className:"bg-gradient-to-r from-primary to-purple-600 hover:opacity-90 text-white",children:[h?"Submitting...":"Submit Review",!h&&s.jsx(Oe,{size:16,className:"ml-2"})]})]})]})})},tr=({contract:e,currentUserId:t,onContractUpdate:r,onSendMessage:a,conversationId:n,listingId:i,travelerUserId:o,senderUserId:c})=>{const{toast:d}=J(),[l,u]=p.useState(!1),[h,g]=p.useState(!1),[v,_]=p.useState(null),[b,f]=p.useState(null),[m,y]=p.useState(""),[w,S]=p.useState(null),[C,F]=p.useState(null),A=t===o,M=t===c,Y=p.useCallback(async()=>{if(!t||!o&&!c)return;const{data:j,error:T}=await O.from("profiles").select("id, full_name, email").eq("id",t).single();T?console.error("Error fetching current user profile:",T):S(j);const D=A?c:o;if(D){const{data:R,error:W}=await O.from("profiles").select("id, full_name, email").eq("id",D).single();W?console.error("Error fetching other user profile:",W):F(R)}},[t,o,c,A]);p.useEffect(()=>{Y()},[Y]);const k=async(j,T,D)=>{if(!(e!=null&&e.id)){d({title:"Error",description:"No active contract to update.",variant:"destructive"});return}u(!0);try{const{data:R,error:W}=await O.from("shipments").update({status:j}).eq("id",e.id).select().single();if(W)throw W;r(R),d({title:"Success",description:T,className:"bg-green-500 text-white"}),D&&a&&a(D),(j==="Delivered"||j==="Completed")&&await de(R)}catch(R){console.error("Error updating contract:",R),d({title:"Error",description:`Failed to update contract: ${R.message}`,variant:"destructive"})}finally{u(!1)}},de=async j=>{(!w||!C)&&await Y();const T=C,D=A?"yanker_to_sender":"sender_to_yanker";if(!T){console.warn("Review target user profile not loaded yet.");return}_(T),f(j),y(D),g(!0)},ue=async()=>{if(!i||!t||!o||!c){d({title:"Error",description:"Missing information to create contract.",variant:"destructive"});return}u(!0);try{const{data:j,error:T}=await O.from("shipments").insert({listing_id:i,shipper_user_id:c,traveler_user_id:o,agreed_weight_kg:0,agreed_price:0,status:"Pending Confirmation",conversation_id:n}).select().single();if(T)throw T;r(j),d({title:"Success",description:"Contract initiated! Awaiting confirmation.",className:"bg-green-500 text-white"}),a&&a(`System: Contract initiated by ${M?"Sender":"Traveler"}. Awaiting confirmation.`)}catch(j){console.error("Error creating contract:",j),d({title:"Error",description:`Failed to create contract: ${j.message}`,variant:"destructive"})}finally{u(!1)}};if(!e&&M)return s.jsx("div",{className:"p-3 border-b dark:border-slate-700 bg-slate-100 dark:bg-slate-900/50",children:s.jsxs(N,{onClick:ue,disabled:l,className:"w-full bg-gradient-to-r from-primary to-purple-600 hover:opacity-90 text-white",children:[s.jsx(Bt,{size:18,className:"mr-2"})," ",l?"Initiating...":"Initiate Shipment Contract"]})});if(!e)return s.jsx("div",{className:"p-3 border-b dark:border-slate-700 bg-slate-100 dark:bg-slate-900/50 text-center",children:s.jsxs("p",{className:"text-sm text-muted-foreground dark:text-slate-400 flex items-center justify-center",children:[s.jsx(De,{size:16,className:"mr-2"})," Waiting for Sender to initiate the contract."]})});const $=()=>{switch(e.status){case"Pending Confirmation":return s.jsxs(N,{onClick:()=>k("Awaiting Pickup","Contract confirmed! Ready for item pickup.","System: Traveler confirmed the contract. Ready for item pickup."),disabled:l,className:"w-full bg-green-500 hover:bg-green-600 text-white",children:[s.jsx(Z,{size:18,className:"mr-2"})," ",l?"Confirming...":"Confirm Contract"]});case"Awaiting Pickup":return s.jsxs(N,{onClick:()=>k("In Transit","Item picked up and in transit.","System: Traveler marked item as picked up and in transit."),disabled:l,className:"w-full bg-blue-500 hover:bg-blue-600 text-white",children:[s.jsx(Oe,{size:18,className:"mr-2"})," ",l?"Updating...":"Mark as In Transit"]});case"Delivered":return s.jsxs("div",{className:"flex items-center justify-center text-green-600 dark:text-green-400",children:[s.jsx(Z,{size:18,className:"mr-2"})," Item delivered. Waiting for Sender to complete."]});case"Completed":return s.jsxs("div",{className:"flex items-center justify-center text-green-600 dark:text-green-400",children:[s.jsx(Re,{size:18,className:"mr-2"})," Transaction Completed!"]});default:return null}},E=()=>{switch(e.status){case"Pending Confirmation":return s.jsxs("div",{className:"flex items-center justify-center text-orange-500 dark:text-orange-400",children:[s.jsx(De,{size:18,className:"mr-2"})," Awaiting Traveler's confirmation."]});case"In Transit":return s.jsxs(fe,{children:[s.jsx(pe,{asChild:!0,children:s.jsxs(N,{disabled:l,className:"w-full bg-green-500 hover:bg-green-600 text-white",children:[s.jsx(Z,{size:18,className:"mr-2"})," ",l?"Processing...":"Mark as Delivered & Complete"]})}),s.jsxs(ge,{children:[s.jsxs(me,{children:[s.jsx(he,{children:"Confirm Delivery?"}),s.jsx(ve,{children:"By confirming, you acknowledge that you have received the item(s) and the transaction will be marked as completed. This action cannot be undone."})]}),s.jsxs(ye,{children:[s.jsx(_e,{children:"Cancel"}),s.jsx(xe,{onClick:()=>k("Completed","Shipment marked as delivered and completed!","System: Sender confirmed delivery. Transaction completed."),className:"bg-green-500 hover:bg-green-600",children:"Confirm Delivery"})]})]})]});case"Delivered":return s.jsxs(fe,{children:[s.jsx(pe,{asChild:!0,children:s.jsxs(N,{disabled:l,className:"w-full bg-green-500 hover:bg-green-600 text-white",children:[s.jsx(Z,{size:18,className:"mr-2"})," ",l?"Processing...":"Confirm Receipt & Complete"]})}),s.jsxs(ge,{children:[s.jsxs(me,{children:[s.jsx(he,{children:"Confirm Receipt?"}),s.jsx(ve,{children:"Confirming receipt will complete the transaction. This action cannot be undone."})]}),s.jsxs(ye,{children:[s.jsx(_e,{children:"Cancel"}),s.jsx(xe,{onClick:()=>k("Completed","Shipment receipt confirmed and completed!","System: Sender confirmed receipt. Transaction completed."),className:"bg-green-500 hover:bg-green-600",children:"Confirm Receipt"})]})]})]});case"Completed":return s.jsxs("div",{className:"flex items-center justify-center text-green-600 dark:text-green-400",children:[s.jsx(Re,{size:18,className:"mr-2"})," Transaction Completed!"]});default:return null}},H=()=>e.status!=="Completed"&&e.status!=="Cancelled"?s.jsxs(fe,{children:[s.jsx(pe,{asChild:!0,children:s.jsxs(N,{variant:"destructive",size:"sm",disabled:l,className:"w-full mt-2",children:[s.jsx(Kt,{size:18,className:"mr-2"})," ",l?"Cancelling...":"Cancel Contract"]})}),s.jsxs(ge,{children:[s.jsxs(me,{children:[s.jsx(he,{children:"Are you sure you want to cancel?"}),s.jsxs(ve,{children:["This action will cancel the contract. This may have implications based on ",s.jsx("span",{className:"font-vernaccia-bold",children:"Yankit"}),"'s terms of service."]})]}),s.jsxs(ye,{children:[s.jsx(_e,{children:"Keep Contract"}),s.jsx(xe,{onClick:()=>k("Cancelled","Contract cancelled.",`System: Contract cancelled by ${A?"Traveler":"Sender"}.`),className:"bg-red-500 hover:bg-red-600",children:"Yes, Cancel Contract"})]})]})]}):null;return s.jsxs("div",{className:"p-3 border-b dark:border-slate-700 bg-slate-100 dark:bg-slate-900/50 space-y-2",children:[s.jsxs("div",{className:"flex items-center justify-between text-sm mb-2",children:[s.jsx("span",{className:"font-semibold text-slate-700 dark:text-slate-200",children:"Contract Status:"}),s.jsx("span",{className:`px-2 py-1 text-xs rounded-full font-medium
              ${e.status==="In Transit"?"bg-blue-100 text-blue-700 dark:bg-blue-700 dark:text-blue-100":e.status==="Delivered"?"bg-green-100 text-green-700 dark:bg-green-700 dark:text-green-100":e.status==="Completed"?"bg-emerald-100 text-emerald-700 dark:bg-emerald-700 dark:text-emerald-100":e.status==="Awaiting Pickup"?"bg-yellow-100 text-yellow-700 dark:bg-yellow-700 dark:text-yellow-100":e.status==="Pending Confirmation"?"bg-orange-100 text-orange-700 dark:bg-orange-700 dark:text-orange-100":e.status==="Cancelled"?"bg-red-100 text-red-700 dark:bg-red-700 dark:text-red-100":"bg-gray-100 text-gray-700 dark:bg-gray-600 dark:text-gray-200"}`,children:e.status})]}),A&&$(),M&&E(),H(),h&&w&&C&&b&&s.jsx(er,{isOpen:h,setIsOpen:g,shipment:b,currentUser:w,otherUser:C,reviewType:m,onReviewSubmitted:()=>{d({title:"Review recorded!",description:"Thank you for your feedback."})}})]})},rr=(e=[])=>{const[t,r]=p.useState(e),a=p.useCallback(c=>{const d=`temp_${Date.now()}_${Math.random().toString(36).substring(2,7)}`,l={...c,id:d,created_at:new Date().toISOString(),status:"sending"};return r(u=>[...u,l]),d},[]),n=p.useCallback(c=>{r(d=>d.filter(l=>l.id!==c))},[]),i=p.useCallback((c,d)=>{r(l=>l.map(u=>u.id===c?{...d,status:"sent"}:u))},[]),o=p.useCallback(c=>{r(c)},[]);return[t,o,a,n,i]},ar=.21,sr=({conversationId:e,currentUserId:t,otherUserId:r,listingId:a,listingDetails:n,toast:i})=>{const[o,c]=p.useState(null),[d,l]=p.useState(!1),[u,h]=p.useState({item_description:"",agreed_price:"",currency:"USD",item_weight_kg:""}),g=p.useCallback(async()=>{if(e){l(!0);try{const{data:f,error:m}=await O.from("contracts").select("*").eq("conversation_id",e).maybeSingle();if(m)throw m;c(f),f?h(y=>({...y,item_description:f.item_description||"",agreed_price:f.agreed_price||"",currency:f.currency||"USD"})):n!=null&&n.price_per_kg?h(y=>({...y,item_description:"",agreed_price:"",currency:"USD",item_weight_kg:""})):h({item_description:"",agreed_price:"",currency:"USD",item_weight_kg:""})}catch(f){console.error("Error fetching contract:",f),i({title:"Error",description:"Could not load contract details.",variant:"destructive"})}finally{l(!1)}}},[e,i,n]);p.useEffect(()=>{g()},[g]);const v=p.useCallback(f=>{const{name:m,value:y}=f.target;h(w=>({...w,[m]:y}))},[]);return{contract:o,setContract:c,isContractLoading:d,contractFormData:u,handleContractFormChange:v,handleProposeContract:async()=>{if(!u.item_description.trim()||!u.currency){i({title:"Missing Information",description:"Please fill in item description and currency.",variant:"destructive"});return}let f=parseFloat(u.agreed_price);if(n!=null&&n.price_per_kg&&u.item_weight_kg){const m=parseFloat(n.price_per_kg),y=parseFloat(u.item_weight_kg);if(isNaN(m)||isNaN(y)||y<=0){i({title:"Invalid Input",description:"Please enter a valid item weight.",variant:"destructive"});return}f=m*y}else if(isNaN(f)||f<=0){i({title:"Invalid Price",description:"Please ensure a valid price for the traveler.",variant:"destructive"});return}l(!0);try{const m=t,y=r,{data:w,error:S}=await O.from("contracts").insert({conversation_id:e,listing_id:a,sender_user_id:m,traveler_user_id:y,item_description:u.item_description,agreed_price:f,currency:u.currency,status:"pending_agreement",updated_at:new Date().toISOString(),created_at:new Date().toISOString()}).select().single();if(S)throw S;c(w),h(C=>({...C,agreed_price:w.agreed_price.toString()})),i({title:"Success",description:"Contract proposed."})}catch(m){console.error("Error proposing contract:",m),i({title:"Error",description:`Could not propose contract. ${m.message}`,variant:"destructive"})}finally{l(!1)}},handleAgreeToContract:async()=>{if(!o)return;l(!0);const f={updated_at:new Date().toISOString()};let m=o.status,y=!1;if(t===o.sender_user_id&&!o.sender_agreed_at?(f.sender_agreed_at=new Date().toISOString(),m=o.traveler_agreed_at?"active":"sender_agreed",y=!0):t===o.traveler_user_id&&!o.traveler_agreed_at&&(f.traveler_agreed_at=new Date().toISOString(),m=o.sender_agreed_at?"active":"traveler_agreed",y=!0),!y){i({title:"Info",description:"You have already agreed or cannot agree to this contract at this stage."}),l(!1);return}f.status=m;try{const{data:w,error:S}=await O.from("contracts").update(f).eq("id",o.id).select().single();if(S)throw S;if(c(w),i({title:"Success",description:"You agreed to the contract."}),w.status==="active"){const C=parseFloat(w.agreed_price),F=C*ar,A=C+F;i({title:"Contract Active!",description:`Both parties agreed. Traveler receives $${C.toFixed(2)}. Sender to pay $${A.toFixed(2)}. Sender can now proceed to payment.`,duration:7e3})}}catch(w){console.error("Error agreeing to contract:",w),i({title:"Error",description:`Could not agree to contract. ${w.message}`,variant:"destructive"})}finally{l(!1)}}}};function nr(){this.__data__=[],this.size=0}var ir=nr;function or(e,t){return e===t||e!==e&&t!==t}var ht=or,cr=ht;function lr(e,t){for(var r=e.length;r--;)if(cr(e[r][0],t))return r;return-1}var se=lr,dr=se,ur=Array.prototype,fr=ur.splice;function pr(e){var t=this.__data__,r=dr(t,e);if(r<0)return!1;var a=t.length-1;return r==a?t.pop():fr.call(t,r,1),--this.size,!0}var gr=pr,mr=se;function hr(e){var t=this.__data__,r=mr(t,e);return r<0?void 0:t[r][1]}var vr=hr,yr=se;function _r(e){return yr(this.__data__,e)>-1}var xr=_r,br=se;function wr(e,t){var r=this.__data__,a=br(r,e);return a<0?(++this.size,r.push([e,t])):r[a][1]=t,this}var $r=wr,Cr=ir,jr=gr,Sr=vr,Tr=xr,Ar=$r;function G(e){var t=-1,r=e==null?0:e.length;for(this.clear();++t<r;){var a=e[t];this.set(a[0],a[1])}}G.prototype.clear=Cr;G.prototype.delete=jr;G.prototype.get=Sr;G.prototype.has=Tr;G.prototype.set=Ar;var ne=G,Nr=ne;function Or(){this.__data__=new Nr,this.size=0}var Er=Or;function Pr(e){var t=this.__data__,r=t.delete(e);return this.size=t.size,r}var kr=Pr;function Mr(e){return this.__data__.get(e)}var Dr=Mr;function Rr(e){return this.__data__.has(e)}var Ir=Rr,Lr=typeof X=="object"&&X&&X.Object===Object&&X,vt=Lr,Fr=vt,Hr=typeof self=="object"&&self&&self.Object===Object&&self,Gr=Fr||Hr||Function("return this")(),P=Gr,qr=P,zr=qr.Symbol,Ee=zr,Ie=Ee,yt=Object.prototype,Br=yt.hasOwnProperty,Kr=yt.toString,V=Ie?Ie.toStringTag:void 0;function Ur(e){var t=Br.call(e,V),r=e[V];try{e[V]=void 0;var a=!0}catch{}var n=Kr.call(e);return a&&(t?e[V]=r:delete e[V]),n}var Yr=Ur,Wr=Object.prototype,Vr=Wr.toString;function Jr(e){return Vr.call(e)}var Xr=Jr,Le=Ee,Zr=Yr,Qr=Xr,ea="[object Null]",ta="[object Undefined]",Fe=Le?Le.toStringTag:void 0;function ra(e){return e==null?e===void 0?ta:ea:Fe&&Fe in Object(e)?Zr(e):Qr(e)}var ie=ra;function aa(e){var t=typeof e;return e!=null&&(t=="object"||t=="function")}var _t=aa,sa=ie,na=_t,ia="[object AsyncFunction]",oa="[object Function]",ca="[object GeneratorFunction]",la="[object Proxy]";function da(e){if(!na(e))return!1;var t=sa(e);return t==oa||t==ca||t==ia||t==la}var xt=da,ua=P,fa=ua["__core-js_shared__"],pa=fa,be=pa,He=function(){var e=/[^.]+$/.exec(be&&be.keys&&be.keys.IE_PROTO||"");return e?"Symbol(src)_1."+e:""}();function ga(e){return!!He&&He in e}var ma=ga,ha=Function.prototype,va=ha.toString;function ya(e){if(e!=null){try{return va.call(e)}catch{}try{return e+""}catch{}}return""}var bt=ya,_a=xt,xa=ma,ba=_t,wa=bt,$a=/[\\^$.*+?()[\]{}|]/g,Ca=/^\[object .+?Constructor\]$/,ja=Function.prototype,Sa=Object.prototype,Ta=ja.toString,Aa=Sa.hasOwnProperty,Na=RegExp("^"+Ta.call(Aa).replace($a,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$");function Oa(e){if(!ba(e)||xa(e))return!1;var t=_a(e)?Na:Ca;return t.test(wa(e))}var Ea=Oa;function Pa(e,t){return e==null?void 0:e[t]}var ka=Pa,Ma=Ea,Da=ka;function Ra(e,t){var r=Da(e,t);return Ma(r)?r:void 0}var q=Ra,Ia=q,La=P,Fa=Ia(La,"Map"),Pe=Fa,Ha=q,Ga=Ha(Object,"create"),oe=Ga,Ge=oe;function qa(){this.__data__=Ge?Ge(null):{},this.size=0}var za=qa;function Ba(e){var t=this.has(e)&&delete this.__data__[e];return this.size-=t?1:0,t}var Ka=Ba,Ua=oe,Ya="__lodash_hash_undefined__",Wa=Object.prototype,Va=Wa.hasOwnProperty;function Ja(e){var t=this.__data__;if(Ua){var r=t[e];return r===Ya?void 0:r}return Va.call(t,e)?t[e]:void 0}var Xa=Ja,Za=oe,Qa=Object.prototype,es=Qa.hasOwnProperty;function ts(e){var t=this.__data__;return Za?t[e]!==void 0:es.call(t,e)}var rs=ts,as=oe,ss="__lodash_hash_undefined__";function ns(e,t){var r=this.__data__;return this.size+=this.has(e)?0:1,r[e]=as&&t===void 0?ss:t,this}var is=ns,os=za,cs=Ka,ls=Xa,ds=rs,us=is;function z(e){var t=-1,r=e==null?0:e.length;for(this.clear();++t<r;){var a=e[t];this.set(a[0],a[1])}}z.prototype.clear=os;z.prototype.delete=cs;z.prototype.get=ls;z.prototype.has=ds;z.prototype.set=us;var fs=z,qe=fs,ps=ne,gs=Pe;function ms(){this.size=0,this.__data__={hash:new qe,map:new(gs||ps),string:new qe}}var hs=ms;function vs(e){var t=typeof e;return t=="string"||t=="number"||t=="symbol"||t=="boolean"?e!=="__proto__":e===null}var ys=vs,_s=ys;function xs(e,t){var r=e.__data__;return _s(t)?r[typeof t=="string"?"string":"hash"]:r.map}var ce=xs,bs=ce;function ws(e){var t=bs(this,e).delete(e);return this.size-=t?1:0,t}var $s=ws,Cs=ce;function js(e){return Cs(this,e).get(e)}var Ss=js,Ts=ce;function As(e){return Ts(this,e).has(e)}var Ns=As,Os=ce;function Es(e,t){var r=Os(this,e),a=r.size;return r.set(e,t),this.size+=r.size==a?0:1,this}var Ps=Es,ks=hs,Ms=$s,Ds=Ss,Rs=Ns,Is=Ps;function B(e){var t=-1,r=e==null?0:e.length;for(this.clear();++t<r;){var a=e[t];this.set(a[0],a[1])}}B.prototype.clear=ks;B.prototype.delete=Ms;B.prototype.get=Ds;B.prototype.has=Rs;B.prototype.set=Is;var wt=B,Ls=ne,Fs=Pe,Hs=wt,Gs=200;function qs(e,t){var r=this.__data__;if(r instanceof Ls){var a=r.__data__;if(!Fs||a.length<Gs-1)return a.push([e,t]),this.size=++r.size,this;r=this.__data__=new Hs(a)}return r.set(e,t),this.size=r.size,this}var zs=qs,Bs=ne,Ks=Er,Us=kr,Ys=Dr,Ws=Ir,Vs=zs;function K(e){var t=this.__data__=new Bs(e);this.size=t.size}K.prototype.clear=Ks;K.prototype.delete=Us;K.prototype.get=Ys;K.prototype.has=Ws;K.prototype.set=Vs;var Js=K,Xs="__lodash_hash_undefined__";function Zs(e){return this.__data__.set(e,Xs),this}var Qs=Zs;function en(e){return this.__data__.has(e)}var tn=en,rn=wt,an=Qs,sn=tn;function te(e){var t=-1,r=e==null?0:e.length;for(this.__data__=new rn;++t<r;)this.add(e[t])}te.prototype.add=te.prototype.push=an;te.prototype.has=sn;var nn=te;function on(e,t){for(var r=-1,a=e==null?0:e.length;++r<a;)if(t(e[r],r,e))return!0;return!1}var cn=on;function ln(e,t){return e.has(t)}var dn=ln,un=nn,fn=cn,pn=dn,gn=1,mn=2;function hn(e,t,r,a,n,i){var o=r&gn,c=e.length,d=t.length;if(c!=d&&!(o&&d>c))return!1;var l=i.get(e),u=i.get(t);if(l&&u)return l==t&&u==e;var h=-1,g=!0,v=r&mn?new un:void 0;for(i.set(e,t),i.set(t,e);++h<c;){var _=e[h],b=t[h];if(a)var f=o?a(b,_,h,t,e,i):a(_,b,h,e,t,i);if(f!==void 0){if(f)continue;g=!1;break}if(v){if(!fn(t,function(m,y){if(!pn(v,y)&&(_===m||n(_,m,r,a,i)))return v.push(y)})){g=!1;break}}else if(!(_===b||n(_,b,r,a,i))){g=!1;break}}return i.delete(e),i.delete(t),g}var $t=hn,vn=P,yn=vn.Uint8Array,_n=yn;function xn(e){var t=-1,r=Array(e.size);return e.forEach(function(a,n){r[++t]=[n,a]}),r}var bn=xn;function wn(e){var t=-1,r=Array(e.size);return e.forEach(function(a){r[++t]=a}),r}var $n=wn,ze=Ee,Be=_n,Cn=ht,jn=$t,Sn=bn,Tn=$n,An=1,Nn=2,On="[object Boolean]",En="[object Date]",Pn="[object Error]",kn="[object Map]",Mn="[object Number]",Dn="[object RegExp]",Rn="[object Set]",In="[object String]",Ln="[object Symbol]",Fn="[object ArrayBuffer]",Hn="[object DataView]",Ke=ze?ze.prototype:void 0,we=Ke?Ke.valueOf:void 0;function Gn(e,t,r,a,n,i,o){switch(r){case Hn:if(e.byteLength!=t.byteLength||e.byteOffset!=t.byteOffset)return!1;e=e.buffer,t=t.buffer;case Fn:return!(e.byteLength!=t.byteLength||!i(new Be(e),new Be(t)));case On:case En:case Mn:return Cn(+e,+t);case Pn:return e.name==t.name&&e.message==t.message;case Dn:case In:return e==t+"";case kn:var c=Sn;case Rn:var d=a&An;if(c||(c=Tn),e.size!=t.size&&!d)return!1;var l=o.get(e);if(l)return l==t;a|=Nn,o.set(e,t);var u=jn(c(e),c(t),a,n,i,o);return o.delete(e),u;case Ln:if(we)return we.call(e)==we.call(t)}return!1}var qn=Gn;function zn(e,t){for(var r=-1,a=t.length,n=e.length;++r<a;)e[n+r]=t[r];return e}var Bn=zn,Kn=Array.isArray,ke=Kn,Un=Bn,Yn=ke;function Wn(e,t,r){var a=t(e);return Yn(e)?a:Un(a,r(e))}var Vn=Wn;function Jn(e,t){for(var r=-1,a=e==null?0:e.length,n=0,i=[];++r<a;){var o=e[r];t(o,r,e)&&(i[n++]=o)}return i}var Xn=Jn;function Zn(){return[]}var Qn=Zn,ei=Xn,ti=Qn,ri=Object.prototype,ai=ri.propertyIsEnumerable,Ue=Object.getOwnPropertySymbols,si=Ue?function(e){return e==null?[]:(e=Object(e),ei(Ue(e),function(t){return ai.call(e,t)}))}:ti,ni=si;function ii(e,t){for(var r=-1,a=Array(e);++r<e;)a[r]=t(r);return a}var oi=ii;function ci(e){return e!=null&&typeof e=="object"}var le=ci,li=ie,di=le,ui="[object Arguments]";function fi(e){return di(e)&&li(e)==ui}var pi=fi,Ye=pi,gi=le,Ct=Object.prototype,mi=Ct.hasOwnProperty,hi=Ct.propertyIsEnumerable,vi=Ye(function(){return arguments}())?Ye:function(e){return gi(e)&&mi.call(e,"callee")&&!hi.call(e,"callee")},yi=vi,re={exports:{}};function _i(){return!1}var xi=_i;re.exports;(function(e,t){var r=P,a=xi,n=t&&!t.nodeType&&t,i=n&&!0&&e&&!e.nodeType&&e,o=i&&i.exports===n,c=o?r.Buffer:void 0,d=c?c.isBuffer:void 0,l=d||a;e.exports=l})(re,re.exports);var jt=re.exports,bi=9007199254740991,wi=/^(?:0|[1-9]\d*)$/;function $i(e,t){var r=typeof e;return t=t??bi,!!t&&(r=="number"||r!="symbol"&&wi.test(e))&&e>-1&&e%1==0&&e<t}var Ci=$i,ji=9007199254740991;function Si(e){return typeof e=="number"&&e>-1&&e%1==0&&e<=ji}var St=Si,Ti=ie,Ai=St,Ni=le,Oi="[object Arguments]",Ei="[object Array]",Pi="[object Boolean]",ki="[object Date]",Mi="[object Error]",Di="[object Function]",Ri="[object Map]",Ii="[object Number]",Li="[object Object]",Fi="[object RegExp]",Hi="[object Set]",Gi="[object String]",qi="[object WeakMap]",zi="[object ArrayBuffer]",Bi="[object DataView]",Ki="[object Float32Array]",Ui="[object Float64Array]",Yi="[object Int8Array]",Wi="[object Int16Array]",Vi="[object Int32Array]",Ji="[object Uint8Array]",Xi="[object Uint8ClampedArray]",Zi="[object Uint16Array]",Qi="[object Uint32Array]",x={};x[Ki]=x[Ui]=x[Yi]=x[Wi]=x[Vi]=x[Ji]=x[Xi]=x[Zi]=x[Qi]=!0;x[Oi]=x[Ei]=x[zi]=x[Pi]=x[Bi]=x[ki]=x[Mi]=x[Di]=x[Ri]=x[Ii]=x[Li]=x[Fi]=x[Hi]=x[Gi]=x[qi]=!1;function eo(e){return Ni(e)&&Ai(e.length)&&!!x[Ti(e)]}var to=eo;function ro(e){return function(t){return e(t)}}var ao=ro,ae={exports:{}};ae.exports;(function(e,t){var r=vt,a=t&&!t.nodeType&&t,n=a&&!0&&e&&!e.nodeType&&e,i=n&&n.exports===a,o=i&&r.process,c=function(){try{var d=n&&n.require&&n.require("util").types;return d||o&&o.binding&&o.binding("util")}catch{}}();e.exports=c})(ae,ae.exports);var so=ae.exports,no=to,io=ao,We=so,Ve=We&&We.isTypedArray,oo=Ve?io(Ve):no,Tt=oo,co=oi,lo=yi,uo=ke,fo=jt,po=Ci,go=Tt,mo=Object.prototype,ho=mo.hasOwnProperty;function vo(e,t){var r=uo(e),a=!r&&lo(e),n=!r&&!a&&fo(e),i=!r&&!a&&!n&&go(e),o=r||a||n||i,c=o?co(e.length,String):[],d=c.length;for(var l in e)(t||ho.call(e,l))&&!(o&&(l=="length"||n&&(l=="offset"||l=="parent")||i&&(l=="buffer"||l=="byteLength"||l=="byteOffset")||po(l,d)))&&c.push(l);return c}var yo=vo,_o=Object.prototype;function xo(e){var t=e&&e.constructor,r=typeof t=="function"&&t.prototype||_o;return e===r}var bo=xo;function wo(e,t){return function(r){return e(t(r))}}var $o=wo,Co=$o,jo=Co(Object.keys,Object),So=jo,To=bo,Ao=So,No=Object.prototype,Oo=No.hasOwnProperty;function Eo(e){if(!To(e))return Ao(e);var t=[];for(var r in Object(e))Oo.call(e,r)&&r!="constructor"&&t.push(r);return t}var Po=Eo,ko=xt,Mo=St;function Do(e){return e!=null&&Mo(e.length)&&!ko(e)}var Ro=Do,Io=yo,Lo=Po,Fo=Ro;function Ho(e){return Fo(e)?Io(e):Lo(e)}var Go=Ho,qo=Vn,zo=ni,Bo=Go;function Ko(e){return qo(e,Bo,zo)}var Uo=Ko,Je=Uo,Yo=1,Wo=Object.prototype,Vo=Wo.hasOwnProperty;function Jo(e,t,r,a,n,i){var o=r&Yo,c=Je(e),d=c.length,l=Je(t),u=l.length;if(d!=u&&!o)return!1;for(var h=d;h--;){var g=c[h];if(!(o?g in t:Vo.call(t,g)))return!1}var v=i.get(e),_=i.get(t);if(v&&_)return v==t&&_==e;var b=!0;i.set(e,t),i.set(t,e);for(var f=o;++h<d;){g=c[h];var m=e[g],y=t[g];if(a)var w=o?a(y,m,g,t,e,i):a(m,y,g,e,t,i);if(!(w===void 0?m===y||n(m,y,r,a,i):w)){b=!1;break}f||(f=g=="constructor")}if(b&&!f){var S=e.constructor,C=t.constructor;S!=C&&"constructor"in e&&"constructor"in t&&!(typeof S=="function"&&S instanceof S&&typeof C=="function"&&C instanceof C)&&(b=!1)}return i.delete(e),i.delete(t),b}var Xo=Jo,Zo=q,Qo=P,ec=Zo(Qo,"DataView"),tc=ec,rc=q,ac=P,sc=rc(ac,"Promise"),nc=sc,ic=q,oc=P,cc=ic(oc,"Set"),lc=cc,dc=q,uc=P,fc=dc(uc,"WeakMap"),pc=fc,Ce=tc,je=Pe,Se=nc,Te=lc,Ae=pc,At=ie,U=bt,Xe="[object Map]",gc="[object Object]",Ze="[object Promise]",Qe="[object Set]",et="[object WeakMap]",tt="[object DataView]",mc=U(Ce),hc=U(je),vc=U(Se),yc=U(Te),_c=U(Ae),I=At;(Ce&&I(new Ce(new ArrayBuffer(1)))!=tt||je&&I(new je)!=Xe||Se&&I(Se.resolve())!=Ze||Te&&I(new Te)!=Qe||Ae&&I(new Ae)!=et)&&(I=function(e){var t=At(e),r=t==gc?e.constructor:void 0,a=r?U(r):"";if(a)switch(a){case mc:return tt;case hc:return Xe;case vc:return Ze;case yc:return Qe;case _c:return et}return t});var xc=I,$e=Js,bc=$t,wc=qn,$c=Xo,rt=xc,at=ke,st=jt,Cc=Tt,jc=1,nt="[object Arguments]",it="[object Array]",Q="[object Object]",Sc=Object.prototype,ot=Sc.hasOwnProperty;function Tc(e,t,r,a,n,i){var o=at(e),c=at(t),d=o?it:rt(e),l=c?it:rt(t);d=d==nt?Q:d,l=l==nt?Q:l;var u=d==Q,h=l==Q,g=d==l;if(g&&st(e)){if(!st(t))return!1;o=!0,u=!1}if(g&&!u)return i||(i=new $e),o||Cc(e)?bc(e,t,r,a,n,i):wc(e,t,d,r,a,n,i);if(!(r&jc)){var v=u&&ot.call(e,"__wrapped__"),_=h&&ot.call(t,"__wrapped__");if(v||_){var b=v?e.value():e,f=_?t.value():t;return i||(i=new $e),n(b,f,r,a,i)}}return g?(i||(i=new $e),$c(e,t,r,a,n,i)):!1}var Ac=Tc,Nc=Ac,ct=le;function Nt(e,t,r,a,n){return e===t?!0:e==null||t==null||!ct(e)&&!ct(t)?e!==e&&t!==t:Nc(e,t,r,a,Nt,n)}var Oc=Nt,Ec=Oc;function Pc(e,t){return Ec(e,t)}var kc=Pc;const Mc=kt(kc),Dc=e=>{const t=p.useRef();p.useEffect(()=>{if(!Array.isArray(e)||e.length===0||Mc(t.current,e))return;t.current=e;const r=e.map(a=>{if(!a||!a.table||!a.callback)return console.warn("Invalid subscription config:",a),null;const n=`realtime:${a.schema||"public"}:${a.table}:${a.filter||"all"}:${a.event||"*"}`;let i=O.channel(n,{config:{broadcast:{ack:!0}}});return i.on("postgres_changes",{event:a.event||"*",schema:a.schema||"public",table:a.table,filter:a.filter},o=>{a.callback(o)}).subscribe((o,c)=>{o==="SUBSCRIBED"||(o==="CHANNEL_ERROR"?console.error(`Failed to subscribe to ${n}: CHANNEL_ERROR`,c):o==="TIMED_OUT"&&console.error(`Failed to subscribe to ${n}: TIMED_OUT`,c))}),i}).filter(Boolean);return()=>{r.forEach(a=>{a&&O.removeChannel(a).then(n=>{}).catch(n=>{console.error(`Error unsubscribing from channel ${a.topic}:`,n)})})}},[e])},Ot=({conversationId:e,currentUserId:t,otherUserId:r,listingId:a,otherUserName:n,isBaggageShippingChat:i})=>{const[o,c,d,l,u]=rr([]),[h,g]=p.useState(""),[v,_]=p.useState(!0),[b,f]=p.useState(!1),{toast:m}=J(),{contract:y,setContract:w}=sr({conversationId:i?e:null,currentUserId:t,otherUserId:r,listingId:a,toast:m}),S=p.useCallback(async()=>{if(!e){_(!1);return}_(!0);try{const{data:$,error:E}=await O.from("messages").select("*").eq("conversation_id",e).order("created_at",{ascending:!0});if(E)throw E;c($||[])}catch($){console.error("Error fetching messages:",$),m({title:"Error",description:"Could not load messages.",variant:"destructive"})}finally{_(!1)}},[e,m,c]);p.useEffect(()=>{S()},[S]);const C=p.useCallback($=>{c(E=>E.find(H=>H.id===$.new.id)?E:[...E,$.new])},[c]),F=p.useCallback($=>{i&&w($.new)},[w,i]),A=p.useMemo(()=>({table:"messages",filter:`conversation_id=eq.${e}`,callback:C}),[e,C]),M=p.useMemo(()=>i?{table:"contracts",filter:`conversation_id=eq.${e}`,callback:F}:null,[e,F,i]),Y=p.useMemo(()=>{const $=[A];return M&&$.push(M),$},[A,M]);Dc(e?Y:[]);const k=async($,E="text")=>{if(!$.trim()||!e||!t||!r)return;f(!0);const H=d({conversation_id:e,sender_user_id:t,receiver_user_id:r,content:$.trim()});E==="text"&&g("");try{const{data:j,error:T}=await O.from("messages").insert({conversation_id:e,sender_user_id:t,receiver_user_id:r,content:$.trim()}).select().single();if(T)throw T;u(H,j)}catch(j){console.error("Error sending message:",j),m({title:"Error",description:"Could not send message.",variant:"destructive"}),l(H)}finally{f(!1)}},de=$=>{$.preventDefault(),k(h,"text")},ue=$=>{k($,"system")};return!e&&!v?s.jsxs("div",{className:"flex flex-col items-center justify-center h-full p-4 text-center",children:[s.jsx(Mt,{className:"w-12 h-12 text-yellow-500 mb-4"}),s.jsx("p",{className:"text-lg font-medium text-muted-foreground",children:"No conversation selected."}),s.jsx("p",{className:"text-sm text-muted-foreground",children:"Please select or start a conversation to view messages."})]}):s.jsxs("div",{className:"flex flex-col h-full bg-slate-50 dark:bg-slate-800 rounded-lg shadow-inner overflow-hidden",children:[s.jsx(Jt,{otherUserName:n}),i&&s.jsx(tr,{contract:y,currentUserId:t,onContractUpdate:w,onSendMessage:ue,conversationId:e,listingId:a,travelerUserId:(y==null?void 0:y.traveler_user_id)||r,senderUserId:(y==null?void 0:y.sender_user_id)||t}),s.jsx(Xt,{messages:o,currentUserId:t,isLoading:v}),s.jsx(Zt,{newMessage:h,setNewMessage:g,handleSendMessage:de,isSending:b})]})};Ot.defaultProps={isBaggageShippingChat:!0};const Rc=()=>s.jsxs(L.div,{className:"text-center mb-12",initial:{opacity:0,y:-20},animate:{opacity:1,y:0},transition:{duration:.6},children:[s.jsx(Ut,{className:"w-16 h-16 text-primary mx-auto mb-4"}),s.jsx("h1",{className:"text-4xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-primary via-purple-500 to-secondary mb-3",children:"My Shipments"}),s.jsx("p",{className:"text-lg text-muted-foreground dark:text-slate-300 max-w-xl mx-auto",children:"Review bags you have sent and bags you have carried for others. Reviews are an essential way to manage how you interact with the platform."})]}),Ic=()=>{const{session:e}=ut(),[t,r]=p.useState([]),[a,n]=p.useState(!0),[i,o]=p.useState(null),c=p.useCallback(async()=>{if(!(e!=null&&e.user)){n(!1);return}n(!0),o(null);try{const{data:d,error:l}=await ee.from("shipments").select(`
          *,
          listing:listings (*),
          shipper:profiles!shipper_user_id (*),
          traveler:profiles!traveler_user_id (*)
        `).or(`shipper_user_id.eq.${e.user.id},traveler_user_id.eq.${e.user.id}`).order("created_at",{ascending:!1});if(l)throw l;r(d||[])}catch(d){console.error("Failed to fetch user contracts:",d),o(d.message||"An unexpected error occurred.")}finally{n(!1)}},[e]);return p.useEffect(()=>{c()},[c]),{contracts:t,loading:a,error:i,refetchContracts:c}},Lc=e=>{const[t,r]=p.useState(!1),[a,n]=p.useState({conversationId:null,otherUserId:null,listingId:null,otherUserName:null}),{toast:i}=J();return{isChatOpen:t,currentChatInfo:a,handleOpenChat:async(d,l,u,h)=>{let g=d;if(!g&&u&&l)try{const{data:v,error:_}=await ee.from("conversations").select("id").or(`(sender_user_id.eq.${e},traveler_user_id.eq.${l}),(sender_user_id.eq.${l},traveler_user_id.eq.${e})`).eq("listing_id",u).maybeSingle();if(_)throw _;if(v)g=v.id;else{const{data:b,error:f}=await ee.from("conversations").insert({sender_user_id:e,traveler_user_id:l,listing_id:u}).select("id").single();if(f)throw f;g=b.id}}catch(v){console.error("Error managing conversation:",v),i({title:"Error",description:`Could not ${d?"open":"initiate"} chat. Please try again.`,variant:"destructive"});return}else if(!g&&(!u||!l)){console.warn("Attempted to open chat without sufficient information (listingId or otherUserId missing and no conversationId)."),i({title:"Chat Error",description:"Cannot open chat due to missing information.",variant:"destructive"});return}n({conversationId:g,otherUserId:l,listingId:u,otherUserName:h}),r(!0)},handleCloseChat:()=>{r(!1),n({conversationId:null,otherUserId:null,listingId:null,otherUserName:null})},setIsChatOpen:r}},Fc={initial:{opacity:0,y:20},in:{opacity:1,y:0},out:{opacity:0,y:-20}},Hc=(e,t,r,a,n)=>{p.useEffect(()=>{e===null&&!t&&(n({title:"Authentication Required",description:"Please sign in to view your shipments.",variant:"destructive",action:s.jsx(N,{onClick:()=>r("/signin",{state:{from:a.pathname}}),children:"Sign In"})}),a.pathname!=="/signin"&&r("/signin",{state:{from:a.pathname}}))},[e,t,r,n,a.pathname])},Gc=(e,t,r,a)=>{p.useEffect(()=>{const n=new URLSearchParams(e.search);if(n.get("chatOpen")==="true"&&t){const i=n.get("conversationId"),o=n.get("listingId"),c=n.get("recipientId"),d=n.get("recipientName"),l=n.get("itemDescription");if(i&&c){r(i,c,o,d||"User",l||"");const u=new URLSearchParams(e.search);u.delete("chatOpen"),u.delete("conversationId"),u.delete("listingId"),u.delete("recipientId"),u.delete("recipientName"),u.delete("itemDescription"),a(`${e.pathname}?${u.toString()}`,{replace:!0})}}},[e.search,t,r,a,e.pathname])},qc=({message:e="Verifying user session..."})=>s.jsxs("div",{className:"container mx-auto py-12 px-4 md:px-6 min-h-[calc(100vh-180px)] flex flex-col items-center justify-center text-center",children:[s.jsx(Ne,{className:"h-12 w-12 text-primary animate-spin mb-4"}),s.jsx("p",{className:"text-muted-foreground dark:text-slate-300",children:e}),s.jsx("p",{className:"text-sm text-muted-foreground dark:text-slate-400",children:"Please wait a moment."})]}),fl=()=>{var v;const{session:e,loading:t}=ut(),r=(v=e==null?void 0:e.user)==null?void 0:v.id,{sentContracts:a,carryingContracts:n,isLoading:i}=Ic(),o=Dt(),c=Rt(),{toast:d}=J(),{isChatOpen:l,currentChatInfo:u,handleOpenChat:h,setIsChatOpen:g}=Lc(r);return Hc(r,t,o,c,d),Gc(c,r,h,o),dt.useEffect(()=>{const _=new URLSearchParams(c.search),b=_.get("paid"),f=_.get("session_id");if((b==="1"||f)&&r){d({title:"Payment successful 🎉",description:"Bags on the way!"});const m=new URLSearchParams(c.search);m.delete("paid"),m.delete("session_id"),o(`${c.pathname}?${m.toString()}`,{replace:!0})}},[c.search,r,d,o,c.pathname]),t?s.jsx(qc,{message:"Verifying user session..."}):s.jsxs(s.Fragment,{children:[s.jsxs(L.div,{initial:"initial",animate:"in",exit:"out",variants:Fc,transition:{duration:.5},className:"container mx-auto py-12 px-4 md:px-6 min-h-[calc(100vh-180px)]",children:[s.jsx(Rc,{}),s.jsx(Yt,{sentContracts:a,carryingContracts:n,onOpenChat:h,isLoading:i})]}),s.jsx(ft,{open:l,onOpenChange:g,children:s.jsx(pt,{className:"max-w-2xl h-[calc(100vh-4rem)] sm:h-[80vh] p-0 gap-0 flex flex-col",children:s.jsx("div",{className:"flex-grow overflow-y-auto",children:u.conversationId&&r&&s.jsx(Ot,{conversationId:u.conversationId,currentUserId:r,otherUserId:u.otherUserId,listingId:u.listingId,otherUserName:u.otherUserName,initialItemDescription:u.itemDescription})})})})]})};export{fl as default};
