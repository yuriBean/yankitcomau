import{c as P,a2 as G,u as I,b as T,y as U,r as o,j as e,x as h,C as Y,B as p,m as q}from"./index-90132984.js";import{s as u}from"./customSupabaseClient-6a2b5399.js";import{C as D,b as M,c as F,d as A,a as z,e as B}from"./card-20bc08aa.js";import{C as _}from"./credit-card-e15c187e.js";const H=P("RefreshCw",[["path",{d:"M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8",key:"v9h5vc"}],["path",{d:"M21 3v5h-5",key:"1q7to0"}],["path",{d:"M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16",key:"3uifl3"}],["path",{d:"M8 16H3v5",key:"1cv678"}]]),O=()=>{var k,w,N,b;const{shipmentId:n}=G(),l=I(),{toast:s}=T(),{session:i}=U(),[t,C]=o.useState(null),[L,x]=o.useState(!0),[d,y]=o.useState(!1),[g,f]=o.useState(null),v=o.useCallback(async()=>{var r;if(n){x(!0);try{const{data:a,error:c}=await u.from("shipments").select(`
                    *,
                    listing:listings(origin, destination),
                    traveler:traveler_user_id(full_name, avatar_url),
                    shipper:shipper_user_id(full_name, avatar_url)
                `).eq("id",n).single();if(c||!a)throw c||new Error("Shipment not found");if(a.shipper_user_id!==((r=i==null?void 0:i.user)==null?void 0:r.id)){s({variant:"destructive",title:"Unauthorized",description:"You are not authorized to pay for this shipment."}),l("/my-shipments");return}if(a.status!=="pending_payment"){s({title:"Payment Not Required",description:"This shipment is not currently awaiting payment."}),l(`/shipment-tracking/${n}`);return}C(a);const{data:m}=await u.from("shipment_payments").select("revolut_payment_url").eq("shipment_id",n).order("created_at",{ascending:!1}).limit(1).single();m!=null&&m.revolut_payment_url&&f(m.revolut_payment_url)}catch(a){console.error("Error fetching shipment details:",a),s({variant:"destructive",title:"Error",description:`Could not load shipment details: ${a.message}`}),l("/my-shipments")}finally{x(!1)}}},[n,s,l,(k=i==null?void 0:i.user)==null?void 0:k.id]);o.useEffect(()=>{v()},[v]);const j=async()=>{y(!0);try{const{data:r,error:a}=await u.functions.invoke("create-revolut-payment-link",{body:{shipmentId:t.id,amount:t.agreed_price*100,currency:t.currency}});if(a)throw a;if(r.error)throw new Error(r.error);if(r.paymentUrl){f(r.paymentUrl);const{error:c}=await u.from("shipments").update({status:"awaiting_yanker"}).eq("id",n);s(c?{variant:"destructive",title:"Status Update Failed",description:"Could not update shipment status, but your link is ready."}:{title:"Success!",description:"Revolut payment link generated. Redirecting..."}),window.location.href=r.paymentUrl}else throw new Error("Could not retrieve payment URL from response.")}catch(r){console.error("Error generating payment link:",r),s({variant:"destructive",title:"Link Generation Failed",description:r.message})}finally{y(!1)}};if(L)return e.jsx("div",{className:"flex items-center justify-center min-h-[calc(100vh-200px)]",children:e.jsx(h,{className:"h-12 w-12 animate-spin text-primary"})});if(!t)return e.jsxs("div",{className:"container mx-auto py-12 px-4 text-center",children:[e.jsx(Y,{className:"h-12 w-12 mx-auto text-destructive mb-4"}),e.jsx("h1",{className:"text-2xl font-semibold mb-2",children:"Shipment Not Found"}),e.jsx("p",{className:"text-muted-foreground",children:"We couldn't find the shipment you're looking for."}),e.jsx(p,{onClick:()=>l("/my-shipments"),className:"mt-6",children:"Go to My Shipments"})]});const S=((w=t.listing)==null?void 0:w.origin)||t.origin,E=((N=t.listing)==null?void 0:N.destination)||t.destination,R=((b=t.traveler)==null?void 0:b.full_name)||"To be assigned";return e.jsx(q.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},transition:{duration:.5},className:"container mx-auto py-8 px-4 md:px-6",children:e.jsxs(D,{className:"max-w-xl mx-auto shadow-2xl glassmorphism-form dark:bg-slate-800/70 border-slate-200 dark:border-slate-700/50",children:[e.jsxs(M,{className:"bg-gradient-to-r from-primary to-purple-600 text-white p-6 rounded-t-lg",children:[e.jsx(F,{className:"text-2xl md:text-3xl",children:"Complete Your Shipment Payment"}),e.jsxs(A,{className:"text-purple-200",children:["Shipment ID: ",t.id.substring(0,8)]})]}),e.jsxs(z,{className:"p-6 space-y-6",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold mb-2 text-foreground dark:text-white",children:"Shipment Summary"}),e.jsxs("div",{className:"p-4 border rounded-lg bg-slate-50 dark:bg-slate-700/50 text-sm space-y-1",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Route:"})," ",S," to ",E]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Traveler (Yanker):"})," ",R]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Agreed Weight:"})," ",t.agreed_weight_kg," kg"]}),e.jsxs("p",{className:"text-xl font-bold text-primary dark:text-secondary mt-2",children:["Total Amount: ",t.agreed_price," ",t.currency]})]})]}),e.jsx("div",{className:"text-center",children:g?e.jsxs("div",{className:"space-y-4",children:[e.jsx("p",{className:"text-muted-foreground",children:"You already have a payment link. Click to complete your payment."}),e.jsxs(p,{onClick:()=>window.location.href=g,className:"w-full text-lg py-6 bg-gradient-to-r from-green-500 to-emerald-600 hover:opacity-90",children:[e.jsx(_,{className:"mr-2 h-5 w-5"})," Pay Now"]}),e.jsxs(p,{onClick:j,variant:"outline",className:"w-full",disabled:d,children:[d?e.jsx(h,{className:"mr-2 h-4 w-4 animate-spin"}):e.jsx(H,{className:"mr-2 h-4 w-4"}),"Generate New Link"]})]}):e.jsxs(p,{onClick:j,className:"w-full text-lg py-6 bg-gradient-to-r from-primary to-blue-600 hover:opacity-90",disabled:d,children:[d?e.jsx(h,{className:"mr-2 h-5 w-5 animate-spin"}):e.jsx(_,{className:"mr-2 h-5 w-5"}),d?"Generating Link...":"Generate Revolut Payment Link"]})})]}),e.jsx(B,{className:"p-6 border-t dark:border-slate-700/50",children:e.jsx("p",{className:"text-xs text-muted-foreground dark:text-slate-400",children:"You will be redirected to Revolut's secure payment page to complete your transaction. Yankit holds the funds until a traveler is found and the shipment is completed."})})]})})};export{O as default};
